<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeeStablecoin DApp</title>
    <link rel="icon" type="image/png" href="images/feed.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box }
        body { font-family: 'Arial', sans-serif; background: url('images/background.png') no-repeat center center fixed; background-size: cover; color: #fff; line-height: 1.6; display: flex; flex-direction: column; align-items: center; min-height: 100vh }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: inherit; filter: blur(5px); z-index: -1 }
        .header, .container, footer, .modal { position: relative; z-index: 1 }
        .header { padding: 15px 0; text-align: center; width: 100%; background: linear-gradient(180deg, rgba(44,62,80,0.9), rgba(44,62,80,0.5)); box-shadow: 0 2px 10px rgba(0,0,0,0.3) }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 50px }
        .header-top .balance { font-size: 1.2em; color: #F4A261; font-weight: 600 }
        .header-top .actions { display: flex; gap: 12px }
        .action-btn { background: #34495E; color: #fff; border: none; padding: 8px 12px; border-radius: 12px; font-size: 0.9em; cursor: pointer; transition: background 0.3s }
        .action-btn:hover { background: #F4A261 }
        .action-btn i { font-size: 1.1em }
        .container { width: 100%; max-width: 420px; padding: 20px 10px; flex-grow: 1; display: flex; flex-direction: column; gap: 20px }
        .section { background: linear-gradient(145deg, rgba(44,62,80,0.95), rgba(44,62,80,0.85)); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center; transition: transform 0.2s }
        .section:hover { transform: scale(1.02) }
        .section-title { font-size: 1.3em; color: #F4A261; margin-bottom: 15px; font-weight: 600; letter-spacing: 1px }
        .button-group { display: flex; justify-content: center; gap: 12px; margin-top: 15px }
        button { background: #F4A261; color: #fff; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 1em; font-weight: 500; letter-spacing: 0.5px; transition: background 0.3s, transform 0.2s }
        button:hover { background: #E07A5F; transform: scale(1.05) }
        button.loading { opacity: 0.7; pointer-events: none }
        .input-group { display: flex; flex-direction: column; gap: 10px; margin: 15px 0 }
        input { padding: 10px; border: none; border-radius: 15px; background: #34495E; color: #fff; font-size: 1em; text-align: center; font-weight: 500 }
        input:focus { outline: none; box-shadow: 0 0 5px #F4A261 }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0 }
        input[type="number"] { -moz-appearance: textfield }
        .percentage-buttons { display: flex; justify-content: center; gap: 8px; margin: 15px 0 }
        .percentage-btn { background: #F4A261; color: #fff; border: none; padding: 8px 12px; border-radius: 15px; font-size: 0.9em; cursor: pointer; font-weight: 500; transition: background 0.3s, transform 0.2s }
        .percentage-btn:hover { background: #E07A5F; transform: scale(1.05) }
        .info-panel { background: #34495E; padding: 12px; border-radius: 15px; margin-top: 15px; font-size: 0.9em; color: #fff; font-weight: 400; letter-spacing: 0.5px; display: flex; flex-direction: column; gap: 5px }
        .info-panel .health-safe { color: #2ECC71; font-weight: 600 }
        .info-panel .health-warning { color: #F1C40F; font-weight: 600 }
        .info-panel .health-danger { color: #E74C3C; font-weight: 600 }
        .info-panel .health-note { font-size: 0.8em; color: #A8B5D4 }
        .liquidation-list { max-height: 200px; overflow-y: auto; background: #34495E; padding: 12px; border-radius: 15px; margin-top: 15px; font-size: 0.9em; color: #fff }
        .liquidation-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #F4A261 }
        .liquidation-item:last-child { border-bottom: none }
        .liquidation-item span { color: #F4A261; cursor: pointer }
        .liquidation-item span:hover { color: #E07A5F }
        .pagination { display: flex; justify-content: center; gap: 12px; margin-top: 15px }
        .pagination button { background: #F4A261; color: #fff; border: none; padding: 8px 12px; border-radius: 15px; font-size: 0.9em; cursor: pointer }
        .pagination button:disabled { background: #34495E; cursor: not-allowed }
        .pagination span { font-size: 0.9em; color: #F4A261 }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000 }
        .modal-content { background: #2C3E50; padding: 25px; border-radius: 20px; text-align: center; color: #fff; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.5) }
        .modal-content p { margin-bottom: 20px; font-size: 1.1em; font-weight: 500 }
        .modal-content button { background: #F4A261; padding: 10px 20px; border-radius: 25px; font-size: 1em }
        footer { background: linear-gradient(180deg, rgba(30,42,68,0.5), rgba(30,42,68,0.9)); text-align: center; padding: 15px; width: 100%; color: #A8B5D4; font-size: 0.9em; margin-top: 25px }
        @media (max-width: 480px) { button { padding: 8px 16px; font-size: 0.9em } input { font-size: 0.9em } .section-title { font-size: 1.2em } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <span id="feeBalance">0.000000000000000000 FEE</span>
            <div class="actions">
                <button class="action-btn" onclick="window.open('https://x.com/feedcto', '_blank')"><i class="fab fa-twitter"></i></button>
                <button class="action-btn" onclick="window.open('https://t.me/feedcto', '_blank')"><i class="fab fa-telegram-plane"></i></button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="section">
            <div class="section-title">Connect Wallet</div>
            <div class="button-group">
                <button id="connectButton">Connect MetaMask</button>
            </div>
            <div class="info-panel">
                <div>Wallet: <span id="walletAddress">Not connected</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Mint FEE</div>
            <div class="button-group">
                <button id="mintButton">Mint</button>
            </div>
            <div class="input-group">
                <input type="number" id="mintFeedInput" placeholder="FEED Amount" step="any" min="0" oninput="updateEstimatedFee()">
            </div>
            <div class="percentage-buttons">
                <button class="percentage-btn" onclick="setMintPercentage(25)">25%</button>
                <button class="percentage-btn" onclick="setMintPercentage(50)">50%</button>
                <button class="percentage-btn" onclick="setMintPercentage(75)">75%</button>
                <button class="percentage-btn" onclick="setMintPercentage(100)">100%</button>
            </div>
            <div class="info-panel">
                <div>FEED Balance: <span id="feedBalance">0.000000000000000000 FEED</span></div>
                <div>Estimated FEE: <span id="estimatedFee">0.000000000000000000 FEE</span></div>
                <div>FEED Price: <span id="mintFeedPrice">0.000000000000000000 USDT</span></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Burn FEE</div>
            <div class="button-group">
                <button id="burnButton">Burn</button>
            </div>
            <div class="input-group">
                <input type="number" id="burnFeeInput" placeholder="FEE Amount" step="any" min="0">
            </div>
            <div class="percentage-buttons">
                <button class="percentage-btn" onclick="setBurnPercentage(25)">25%</button>
                <button class="percentage-btn" onclick="setBurnPercentage(50)">50%</button>
                <button class="percentage-btn" onclick="setBurnPercentage(75)">75%</button>
                <button class="percentage-btn" onclick="setBurnPercentage(100)">100%</button>
            </div>
            <div class="info-panel">
                <div>Debt: <span id="userDebt">0.000000000000000000 FEE</span></div>
                <div>Collateral: <span id="userCollateral">0.000000000000000000 FEED</span></div>
                <div>Health Ratio: <span id="healthRatio" class="health-safe">N/A</span>%</div>
                <div class="health-note">Health Ratio ≤ 60% means liquidation risk.</div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Liquidate</div>
            <div class="button-group">
                <button id="liquidateButton">Liquidate</button>
            </div>
            <div class="input-group">
                <input type="text" id="liquidateAddressInput" placeholder="User Address to Liquidate" oninput="updateTargetCollateralRatio()`, 'ether')).toFixed(18)} FEE`;
                document.getElementById('userCollateral').innerText = `${parseFloat(web3.utils.fromWei(collateral, 'ether')).toFixed(18)} FEED`;

                const healthRatioElement = document.getElementById('healthRatio');
                const minThreshold = web3.utils.toWei('0.000000000000000001', 'ether'); // 阈值为 10^-18

                if (new web3.utils.BN(debt).lte(new web3.utils.BN(minThreshold)) || new web3.utils.BN(collateral).lte(new web3.utils.BN(minThreshold)) || new web3.utils.BN(feedPrice).lte(new web3.utils.BN('0'))) {
                    healthRatioElement.innerText = 'N/A';
                    healthRatioElement.className = 'health-safe';
                    console.log('Debt, Collateral or FEED Price is below threshold or 0:', { debt, collateral, feedPrice });
                } else {
                    // Calculate Collateral Value = Collateral * FEED Price / 10^18
                    const collateralValue = new web3.utils.BN(collateral).mul(new web3.utils.BN(feedPrice)).div(new web3.utils.BN('10').pow(new web3.utils.BN('18')));
                    // Calculate Health Ratio = (Collateral Value / Debt) * 100
                    const ratio = collateralValue.mul(new web3.utils.BN('100')).div(new web3.utils.BN(debt));
                    const ratioPercent = parseFloat(web3.utils.fromWei(ratio.toString(), 'ether'));

                    console.log('Health Ratio Calculation:', {
                        collateral: collateral.toString(),
                        feedPrice: feedPrice.toString(),
                        collateralValue: collateralValue.toString(),
                        debt: debt.toString(),
                        ratio: ratio.toString(),
                        ratioPercent: ratioPercent
                    });

                    if (isNaN(ratioPercent) || ratioPercent === Infinity || ratioPercent < 0) {
                        healthRatioElement.innerText = 'N/A';
                        healthRatioElement.className = 'health-safe';
                    } else {
                        healthRatioElement.innerText = `${ratioPercent.toFixed(2)}`;
                        if (ratioPercent <= 60) {
                            healthRatioElement.className = 'health-danger';
                        } else if (ratioPercent <= 100) {
                            healthRatioElement.className = 'health-warning';
                        } else {
                            healthRatioElement.className = 'health-safe';
                        }
                    }
                }
                updateEstimatedFee();
            } catch (error) {
                console.error('Error updating balances:', error);
                showModal('Failed to update balances. Please try again.');
            }
        }

        async function updateFeedPrice() {
            if (!web3 || !contract || !accounts || isOperationInProgress) return;
            try {
                const feedPrice = await contract.methods.getFeedPrice().call();
                const formattedPrice = `${parseFloat(web3.utils.fromWei(feedPrice.toString(), 'ether')).toFixed(18)} USDT`;
                document.getElementById('feedPrice').innerText = formattedPrice;
                document.getElementById('mintFeedPrice').innerText = formattedPrice;
                console.log('FEED Price updated:', formattedPrice);
                updateBalances(); // Update health ratio when price changes
            } catch (error) {
                console.error('Error updating feed price:', error);
            }
        }

        async function updateEstimatedFee() {
            if (!web3 || !contract || !accounts || isOperationInProgress) return;
            try {
                const mintFeedInput = document.getElementById('mintFeedInput').value || '0';
                const feedAmountWei = new web3.utils.BN(web3.utils.toWei(mintFeedInput, 'ether'));
                const feeAmountWei = await contract.methods.getFeeAmountFromFeed(feedAmountWei).call();
                document.getElementById('estimatedFee').innerText = `${parseFloat(web3.utils.fromWei(feeAmountWei.toString(), 'ether')).toFixed(18)} FEE`;
            } catch (error) {
                console.error('Error updating estimated fee:', error);
            }
        }

        async function updateTargetCollateralRatio() {
            if (!web3 || !contract || !accounts || isOperationInProgress) return;
            const targetAddress = document.getElementById('liquidateAddressInput').value;
            if (!web3.utils.isAddress(targetAddress)) {
                document.getElementById('targetCollateralRatio').innerText = 'N/A';
                document.getElementById('liquidatableFee').innerText = '0.000000000000000000 FEE';
                document.getElementById('liquidatableCollateral').innerText = '0.000000000000000000 FEED';
                return;
            }
            try {
                const collateralRatio = await contract.methods.getCollateralRatio(targetAddress).call();
                const debt = await contract.methods.debt(targetAddress).call();
                const collateral = await contract.methods.collateral(targetAddress).call();
                document.getElementById('targetCollateralRatio').innerText = debt == 0 ? 'N/A' : `${(parseFloat(web3.utils.fromWei(collateralRatio, 'ether')) / 10**16).toFixed(2)}%`;
                document.getElementById('liquidatableFee').innerText = `${parseFloat(web3.utils.fromWei(debt, 'ether')).toFixed(18)} FEE`;
                document.getElementById('liquidatableCollateral').innerText = `${parseFloat(web3.utils.fromWei(collateral, 'ether')).toFixed(18)} FEED`;
            } catch (error) {
                console.error('Error updating target collateral ratio:', error);
            }
        }

        async function fetchLiquidatableUsers() {
            if (!web3 || !contract || !accounts || isOperationInProgress) return;
            const liquidationList = document.getElementById('liquidationList');
            const pagination = document.getElementById('pagination');
            liquidationList.innerHTML = 'Loading...';
            pagination.innerHTML = '';
            try {
                const usersCount = await contract.methods.getUsersCount().call();
                const totalPages = Math.ceil(usersCount / itemsPerPage);
                const [addresses, ratios, debts, collaterals] = await contract.methods.getLiquidatableAddresses((currentPage - 1) * itemsPerPage, itemsPerPage).call();
                if (addresses.length === 0) { liquidationList.innerHTML = 'No addresses eligible for liquidation.'; return; }
                liquidationList.innerHTML = addresses.map((address, i) => `<div class="liquidation-item"><span onclick="setLiquidateAddress('${address}')">${address.slice(0, 6)}...${address.slice(-4)}</span><span>Ratio: ${(parseFloat(web3.utils.fromWei(ratios[i], 'ether')) / 10**16).toFixed(2)}% | FEE: ${parseFloat(web3.utils.fromWei(debts[i], 'ether')).toFixed(18)} | FEED: ${parseFloat(web3.utils.fromWei(collaterals[i], 'ether')).toFixed(18)}</span></div>`).join('');
                pagination.innerHTML = `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button><span>Page ${currentPage} of ${totalPages}</span><button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            } catch (error) {
                console.error('Error fetching liquidatable users:', error);
            }
        }

        function changePage(page) {
            currentPage = page;
            fetchLiquidatableUsers();
        }

        function setLiquidateAddress(address) {
            document.getElementById('liquidateAddressInput').value = address;
            updateTargetCollateralRatio();
        }

        async function setMintPercentage(percentage) {
            if (!web3 || !contract || !accounts) { showModal('Please connect your wallet first! 🔧'); return; }
            try {
                const feedBalance = await feedContract.methods.balanceOf(accounts[0]).call();
                const feedAmountWei = new web3.utils.BN(feedBalance).mul(new web3.utils.BN(percentage)).div(new web3.utils.BN(100));
                document.getElementById('mintFeedInput').value = parseFloat(web3.utils.fromWei(feedAmountWei.toString(), 'ether')).toFixed(18);
                updateEstimatedFee();
            } catch (error) {
                console.error('Error setting mint percentage:', error);
            }
        }

        async function setBurnPercentage(percentage) {
            if (!web3 || !contract || !accounts) { showModal('Please connect your wallet first! 🔧'); return; }
            try {
                const debt = await contract.methods.debt(accounts[0]).call();
                const debtWei = new web3.utils.BN(debt);
                if (percentage === 100) {
                    // 保留 0.0000000000000001 FEE
                    const reserveAmountWei = new web3.utils.BN(web3.utils.toWei('0.0000000000000001', 'ether'));
                    const burnAmountWei = debtWei.sub(reserveAmountWei).gt(new web3.utils.BN('0')) ? debtWei.sub(reserveAmountWei) : new web3.utils.BN('0');
                    document.getElementById('burnFeeInput').value = parseFloat(web3.utils.fromWei(burnAmountWei.toString(), 'ether')).toFixed(18);
                } else {
                    const burnAmountWei = debtWei.mul(new web3.utils.BN(percentage)).div(new web3.utils.BN(100));
                    document.getElementById('burnFeeInput').value = parseFloat(web3.utils.fromWei(burnAmountWei.toString(), 'ether')).toFixed(18);
                }
                updateBalances();
            } catch (error) {
                console.error('Error setting burn percentage:', error);
            }
        }

        async function checkAndApproveFeed() {
            if (!web3 || !contract || !accounts || !feedContract) { showModal('Please connect your wallet first! 🔧'); return false; }
            try {
                const maxAmount = web3.utils.toBN('0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff');
                showModal('Authorizing FEED... ⏳');
                await feedContract.methods.approve(contractAddress, maxAmount).send({ from: accounts[0], gas: 100000 });
                showModal('Authorization successful! Please confirm the transaction. ✅');
                return true;
            } catch (error) {
                showModal(`Authorization failed: ${error.message}`);
                return false;
            }
        }

        async function mintFee() {
            if (!web3 || !contract || !accounts) { showModal('Please connect your wallet first! 🔧'); return; }
            const feedAmount = document.getElementById('mintFeedInput').value;
            if (!feedAmount || feedAmount <= 0) { showModal('Please enter a valid FEED amount!'); return; }
            try {
                isOperationInProgress = true;
                const mintButton = document.getElementById('mintButton');
                mintButton.classList.add('loading');
                const feedWei = web3.utils.toWei(feedAmount, 'ether');
                const isApproved = await checkAndApproveFeed();
                if (!isApproved) throw new Error('Authorization failed');
                showModal(`Minting with ${feedAmount} FEED... ⛏️`);
                await contract.methods.mint(feedWei).send({ from: accounts[0], gas: 300000 });
                showModal('Transaction successful! 💎');
                document.getElementById('mintFeedInput').value = '';
                updateBalances();
                updateFeedPrice();
                fetchLiquidatableUsers();
            } catch (error) {
                showModal(`Mint failed: ${error.message}`);
            } finally {
                isOperationInProgress = false;
                mintButton.classList.remove('loading');
            }
        }

        async function burnFee() {
            if (!web3 || !contract || !accounts) { showModal('Please connect your wallet first! 🔧'); return; }
            const feeAmount = document.getElementById('burnFeeInput').value;
            if (!feeAmount || feeAmount <= 0) { showModal('Please enter a valid FEE amount!'); return; }
            try {
                isOperationInProgress = true;
                const burnButton = document.getElementById('burnButton');
                burnButton.classList.add('loading');
                const feeWei = web3.utils.toWei(feeAmount, 'ether');
                showModal(`Burning ${feeAmount} FEE... 🔥`);
                await contract.methods.burn(feeWei).send({ from: accounts[0], gas: 200000 });
                showModal('Transaction successful! 🚀');
                document.getElementById('burnFeeInput').value = '';
                updateBalances();
                updateFeedPrice();
                fetchLiquidatableUsers();
            } catch (error) {
                showModal(`Burn failed: ${error.message}`);
            } finally {
                isOperationInProgress = false;
                burnButton.classList.remove('loading');
            }
        }

        async function liquidateUser() {
            if (!web3 || !contract || !accounts) { showModal('Please connect your wallet first! 🔧'); return; }
            const userAddress = document.getElementById('liquidateAddressInput').value;
            if (!web3.utils.isAddress(userAddress)) { showModal('Please enter a valid address!'); return; }
            try {
                isOperationInProgress = true;
                const liquidateButton = document.getElementById('liquidateButton');
                liquidateButton.classList.add('loading');
                showModal(`Liquidating ${userAddress}... ⚡`);
                await contract.methods.liquidate(userAddress).send({ from: accounts[0], gas: 300000 });
                showModal('Transaction successful! 💰');
                updateBalances();
                updateFeedPrice();
                updateTargetCollateralRatio();
                fetchLiquidatableUsers();
            } catch (error) {
                showModal(`Liquidation failed: ${error.message}`);
            } finally {
                isOperationInProgress = false;
                liquidateButton.classList.remove('loading');
            }
        }

        setInterval(() => { if (!isOperationInProgress) updateBalances(); }, 5000);
        setInterval(() => { if (!isOperationInProgress) updateFeedPrice(); }, 60000);
        setInterval(() => { if (!isOperationInProgress) updateTargetCollateralRatio(); }, 5000);
        setInterval(() => { if (!isOperationInProgress) fetchLiquidatableUsers(); }, 60000);

        document.getElementById('connectButton').addEventListener('click', connectWallet);
        document.getElementById('mintButton').addEventListener('click', mintFee);
        document.getElementById('burnButton').addEventListener('click', burnFee);
        document.getElementById('liquidateButton').addEventListener('click', liquidateUser);
        window.ethereum?.on('chainChanged', (chainId) => {
            if (parseInt(chainId, 16) !== 109) {
                showModal('Switched to wrong network. Please reconnect to Shibarium.');
                web3 = null; contract = null; accounts = null;
                document.getElementById('walletAddress').innerText = 'Not connected';
            } else {
                connectWallet();
            }
        });
        window.ethereum?.on('accountsChanged', (newAccounts) => {
            if (newAccounts.length) {
                connectWallet();
            } else {
                showModal('Wallet disconnected. Please reconnect.');
                web3 = null; contract = null; accounts = null;
                document.getElementById('walletAddress').innerText = 'Not connected';
            }
        });
        window.addEventListener('load', () => {
            if (!window.location.protocol.startsWith('http')) {
                showModal('Please run this page via a local server (e.g., "npx serve") to connect MetaMask.');
            } else if (!window.ethereum) {
                showModal('No wallet detected. Please install <a href="https://metamask.io" target="_blank">MetaMask</a>.');
            }
        });
    </script>
</body>
</html>
